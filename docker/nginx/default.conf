# Unified nginx reverse proxy for GPP services
# Routes requests to the appropriate backend service

upstream odpc_backend {
    server gpp-app:8080;
}

upstream publicatiebank_backend {
    server publicatiebank:8000;
}

upstream woo_hoo_backend {
    server woo-hoo:8000;
}

server {
    listen 80 default_server;
    server_name _;

    # Increase timeouts for LLM calls
    proxy_connect_timeout 120s;
    proxy_send_timeout 120s;
    proxy_read_timeout 120s;

    # Health check endpoint
    location /nginx-health {
        access_log off;
        return 200 "healthy\n";
        add_header Content-Type text/plain;
    }

    # GPP-app ODPC API - handles metadata generation via woo-hoo
    # Also handles user/session management
    location /api/v1/metadata/ {
        proxy_pass http://odpc_backend/api/v1/metadata/;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }

    # ODPC authentication endpoints
    location ~ ^/api/(me|challenge|logoff)$ {
        proxy_pass http://odpc_backend;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }

    # ODPC app routes (user groups, publications management)
    location ~ ^/api/v1/(gebruikersgroepen|publicaties|documenten)/ {
        proxy_pass http://odpc_backend;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }

    # woo-hoo API - direct access for testing
    location /woo-hoo/ {
        rewrite ^/woo-hoo/(.*)$ /$1 break;
        proxy_pass http://woo_hoo_backend;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }

    # Publicatiebank API v2 (main API)
    location /api/v2/ {
        proxy_pass http://publicatiebank_backend/api/v2/;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }

    # Catalogi API (OpenZaak compatibility)
    location /catalogi/ {
        proxy_pass http://publicatiebank_backend/catalogi/;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }

    # All other requests go to publicatiebank (Django admin, static files, etc.)
    location / {
        proxy_pass http://publicatiebank_backend/;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }
}
